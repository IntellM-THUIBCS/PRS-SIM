---
layout: page
title: Principle
---
<!--
### [GitHub](https://github.com/cabooster/DeepCAD-RT) | [Paper](https://www.nature.com/articles/s41587-022-01450-8)
-->

<h2 style="color:white;" id="Method">Method</h2>
<p>
The key of RES-SIM is to apply image recorruption strategy<sup>[1]</sup> to create an input-target super-resolution (SR) image pair
 to generate the training dataset for the denoising network
from a single noisy raw SIM image stack. The principle of RES-SIM is schematized in the following figure. 
Given a single noisy raw SIM image, a corrupted image pair is generated by adding random noise ($\mathbf{z}$)
controlled with a conjugated matrix pair ($D$ and $D^{-1}$)
under the assumption of the mixed Poisson-Gaussian noise model as:
</p>
$$
\mathbf{y_A} = \mathbf{y}+D \cdot\mathbf{z},
\mathbf{y_B} = \mathbf{y}-D^{-1}\cdot\mathbf{z}, \tag{1}
$$
<p>
In Eq. 1, $D$ represents the noise-control matrix, which can be used as any invertable matrix 
(typical setting is $\alpha\cdot\mathbf{I}$, where $\alpha$ denotes the noise-control factor and $\mathbf{I}$ denotes the unit matrix).
The random noise $\mathbf{z}$ follows the normal distribution $\mathbf{N}(0,\Sigma_z)$, its standard deviation is represented as:
</p>
$$
\Sigma_z = \sqrt{\beta_1\mathbf{y}+\beta_2}
$$

<p>
The proof of the effectiveness of the denoising network trained with the SR imaging pair generated with Eq. 1 is provided in the following section.
Briefly, the training of RES-SIM mainly takes the following steps:
</p>
+ Employ independent recorruption operation to each raw image in the SIM stack with the same recorruption parameter
+ Apply the conventional SIM algorithm to reconstruction two corrupted SR image
+ Categorize these two SR images as the input and target data of the training dataset.
+ Repeat the recorruption operations 3~5 times on each image stack with different parameters to enrich the dataset.
<p>
In the inference phase, we firstly apply conventional SIM algorithm to the noise raw SIM images to generate a SR image, 
then input it to the pre-trained model, and the final denoised SR image will be output.
</p>

<center><img src="../images/Figure-website-principle.png?raw=true" width="1050" align="center" /></center>

<h2 style="color:white;" id="Theory">Theory</h2>
<p>
In this part, we provide a brief proof of why RES-SIM is capable to effectively perform super-resolution denoising on SIM images
(more details will be discussed in our manuscript).
</p>
<h3 style="color:white;" >Noise distribution of the microscopy image</h3>
Both the imaging environment and the photoelectric equipment bring the detection noise to the microscopy images.
Two typical type of noise is the additive readout noise, and the signal-related shot noise,
which follows the Gaussian distribution and Poisson distribution, respectively.
Based on the mixex Gaussian-Poisson assumption, the detected image can be represented as:<br>
$$
\mathbf{y}=\beta_1\mathcal{P}(\mathbf{x})+\mathcal{N}(0,\beta_2^2) \tag{1}
$$
For a Poisson function $\mathcal{P}(\mathbf{\lambda})$, 
it can be approximate by a Gaussian function as $\mathcal{N}(\lambda,\lambda)$ with low error when the value of $\lambda$ is not too low.
Therefore, for a regular microscopy image with adequate photon budget, Eq. 1 can be simplified as:<br>
$$
\mathbf{y}=\mathbf{x}+\mathcal{N}(0,\beta_1\mathbf{x}+\beta_2^2) \tag{2}
$$
All the following discussion will based on this simplified noise model.

<h3 style="color:white;" >Image recorruption strategy for denoising regular images</h3>
<p>
Here we To prove RES-SIM, we firstly provided a brief review of the classic deep-learning based image denoising method N2N<sup>[2]</sup>,
which utlized two independently captured noisy images of the same sample to train the network. 
For simplicity, we use $\mathbf{y}$ denoting the detected image and $\mathbf{x}$ denoting the noise-free sample information, 
and $\mathbf{n}$ denoting the detection noise, then to optimization function of N2N training with L2-norm loss can be represented as:
</p> 
$$
min\qquad ||\phi(\mathbf{y})-\mathbf{x}||_2^2 \tag{1}
$$
<p> Since $\mathbf{y_1}$ and $\mathbf{y_2}$ are two independently captured image, so their detected noise should be independent, 
then mathetical expection of Eq.3 can be re-written as:
</p>
$$
\begin{align}
    E\{||\phi(\mathbf{y_1})-\mathbf{y_2}||^2_2\} &= E\{||\phi(\mathbf{y_1})-\mathbf{x}+\mathbf{n_2}||^2_2\}\\
    &= E\{||\phi(\mathbf{y_1})-\mathbf{x}||^2_2-2E\{\phi(\mathbf{y_1})-\mathbf{x}\cdot\mathbf{n_2}\}
    +E\{\mathbf{n_2^2}\}\\
    &=  E\{||\phi(\mathbf{y_1})-\mathbf{x}||^2_2-2E\{\phi(\mathbf{y_1})-\mathbf{x}\}\cdot E\{\mathbf{n_2}\}
    +E\{\mathbf{n_2^2}\}\\
    & =  E\{||\phi(\mathbf{y_1})-\mathbf{x}||^2_2+\sigma^2
\end{align}\tag{4}

<p>
In Eq. 4, $E\{||\phi(\mathbf{y_1})-\mathbf{x}||^2_2$ is identical with the optimization function of supervised training with noise-free ground-truth, and 
$\sigma^2$ is a constant. 
Therefore, N2N training scheme is able to gain comparable denoising performance than supervised learning, which has been proved by previous work. 
</p>

<p>
Further for RES-SIM, The underlying mechanism is that the recorrupted image pair satisfies the independent criteria in N2N training.
From a single noisy image $\mathbf{y}$, we generated two corrupted images as:
</p>
$$
\mathbf{y_A}=\mathbf{x}+D\sigma_n\cdot\mathbf{z}+\mathbf{n} \tag{5}
$$
$$
\mathbf{y_B}=\mathbf{x}-D^-1\sigma_n\cdot\mathbf{z}+\mathbf{n} \tag{6}
$$
<p> where $\mathbf{z}$ follows the unit normal distribution $\mathcal{N}(0,1)$. 
Let $\mathbf{n_A}=D\sigma_n\cdot\mathbf{z}+\mathbf{n}$ and 
$\mathbf{n_B} = -D^{-1}\sigma_n\cdot\mathbf{z}+\mathbf{n}$. It is easy to proof that both $\mathbf{n_A}$ and $\mathbf{n_B}$ follow 0-mean normal distribution.
And their covariance is:
</p>

$$
\begin{align}
    cov(\mathbf{n_A},\mathbf{n_B}) &= E\{-(D\sigma_n\mathbf{z}+\mathbf{n})(D^{-1}\sigma_n\mathbf{z}+\mathbf{n})\}\\
    &= -\sigma_n^2E\{\mathbf{z^2}\}+(D-D^{-1})\sigma_nE\{\mathbf{z}\cdot\mathbf{n}\}-E\{\mathbf{n^2}\}\\
    &= -sigma_n^2+sigma_n^2\\
    &= 0 
\end{align}\tag{7}
$$
<p>
Since $\mathbf{n_A}$ and $\mathbf{n_B}$ are two random variable following normal distribution and their covariance is their, 
they are statiscally independent. 
Therefore, $\mathbf{y_A}$ and $\mathbf{y_B}$ statisfy the N2N criteria and can be used as the input and target data to train the denoising network.
</p>
<p>
Summarized by Eq. 2 and Eq .7, the corrupted image pair can be finally represented as:
</p>
$$
\begin{align}
\mathbf{y_A} &= \alpha\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z}+\mathbf{y}\\
\mathbf{y_B} &= -\alpha^{-1}\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z}+\mathbf{y}
\end{align}\tag{8}
$$


<h3 style="color:white;" >Image recorruption strategy for denoising SIM images</h3>
<p>
In this section we further extend image recorruption strategy into SIM images. 
The basic theory of SIM imaging can be referred from [3,4]. From a series raw images $\mathbf{y_1}$, $\mathbf{y_2}$, $\dots$, $\mathbf{y_n}$,
the super-resolution recorrupted image $S(\mathbf{r})$ can be represented as:<br>
</p>
$$
S(\mathbf{r})=\mathcal{F}^{-1}\frac{\sum_{p,m}\tilde{D}_{p,m}(\mathbf{k_r}-m\mathbf{p})\cdot OTF(\mathbf{k_r})}{\sum_{p,m}||OTF(\mathbf{k_r}-m\mathbf{p})||^2+\omega^2}
$$
<p>
All the computation operations for $S(\mathbf{r})$, including matrix multiplication, (inversed) Fourier transformation, Wiener filtering, 
are all linear with no offset. 
Therefore, it is easy to proof that the noise distribution in the reconstructed image $S(\mathbf{r})$ also follows a 0-mean normal distribution.
We apply image corruption stategy to each raw image independently with the same parameter, then the SR recorrupted image pair can be represented as:
</p>
$$
\mathbf{Y_A} = SIM(\alpha\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z_1}+\mathbf{y_1},\dots,
\alpha\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z_n}+\mathbf{y_n})
$$
\mathbf{Y_B} = SIM( -\alpha^{-1}\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z_1}+\mathbf{y_1},\dots,
 -\alpha^{-1}\sqrt{\beta_1\mathbf{x}+\beta_2}\cdot\mathbf{z_n}+\mathbf{y_n})\tag{9}
$$
<p>
The covariance of their noise distribution (denoted as $\mathbf{n_A} and \mathbf{n_B}$) can be represented as: 
</p>
$$
cov(\mathbf{N_A},\mathbf{N_B}) = E\{\sum_{i=j}c_{ij}n_{A,i}\cdot n_{B,j}\}+E\{\sum_{i\ne j}c_{ij}n_{A,i}\cdot n_{B,j}\} \tag{10}
$$
<p>
In Eq. 10, we have $E\{\sum_{i=j}c_{ij}n_{A,i}\cdot n_{B,j}\}=0$ due to the individual image recorruption operation 
and $E\{\sum_{i\ne j}c_{ij}n_{A,i}\cdot n_{B,j}\}=0$ since they are from independent images. 
Therefore, the recorrupted SR image $\mathbf{Y_A}$ and $\mathbf{Y_B}$ still meets the independent criteria to training a denoising network,
 the effectiveness of RES-SIM is proved.
</p>



<h2 style="color:white;" id="Reference">Reference</h2>
<p>
[1] Pang, Tongyao, et al. "Recorrupted-to-recorrupted: unsupervised deep learning for image denoising." Proceedings of the IEEE/CVF conference on computer vision and pattern recognition. 2021. <br>
[2] Lehtinen J, Munkberg J, Hasselgren J, et al. Noise2Noise: Learning image restoration without clean data[J]. arXiv preprint arXiv:1803.04189, 2018. <br>
[3] Gustafsson, M. G. (2000). Surpassing the lateral resolution limit by a factor of two using structured illumination microscopy. Journal of microscopy, 198(2), 82-87.<br>
[4] Gustafsson, M. G., Shao, L., Carlton, P. M., Wang, C. R., Golubovskaya, I. N., Cande, W. Z., ... & Sedat, J. W. (2008). Three-dimensional resolution doubling in wide-field fluorescence microscopy by structured illumination. Biophysical journal, 94(12), 4957-4970.<br>
</p>